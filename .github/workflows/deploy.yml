name: Deploy to Home Server

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: 1. Lấy code mới nhất về
        uses: actions/checkout@v4

      - name: 2. Create .env file
        # Lưu ý: Đảm bảo Secret ENV_FILE trên GitHub KHÔNG có dấu ngoặc kép bao quanh giá trị
        run: |
          cat <<EOF > .env
          ${{ secrets.ENV_FILE }}
          EOF

      - name: 3. Build Docker Image
        run: |
          # Build image từ source code
          docker build -t allen-api:latest -f ./src/Allen.API/Dockerfile .

      - name: 4. Deploy Container
        run: |
          # Dừng và xóa container cũ
          docker stop allen-api || true
          docker rm allen-api || true
          
          # Chạy container mới
          # SỬA LẠI PORT: 8080:8080 để không cần quyền root và khớp với Router
          docker run -d \
            --name allen-api \
            --restart unless-stopped \
            --env-file .env \
            -p 8080:8080 \
            allen-api:latest

      - name: 5. Dọn dẹp rác
        run: |
          # Xóa các image cũ (dangling) để nhẹ máy
          docker image prune -f